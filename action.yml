name: metanorma-cache
description: Cache metanorma-related assets (fonts, workgroups)
inputs:
  cache-site-for-manifest:
    description: Path to valid metanorma.yml manifest file
    default: ''
  extra-input:
    description: Coma (or line) seprated list of directories that effect metanorma build
    default: ''
  cache-site-path:
    description: Path to the output site directory
    default: '_site'
outputs:
  cache-site-cache-hit:
    description: "True if valid cache exists"
    value: ${{ steps.site-cache.outputs.cache-hit }}

runs:
  using: "composite"
  steps:
    - uses: actions/cache@v4
      with:
        path: |
          ~/.metanorma
          /root/.metanorma
        key: metanorma-home
        restore-keys: metanorma-home

    - uses: actions/cache@v4
      with:
        path: |
          ~/.relaton
          /root/.relaton
        key: metanorma-relaton
        restore-keys: metanorma-relaton

    - uses: actions/cache@v4
      with:
        path: |
          ~/.fontist
          /config/fonts
          /root/.fontist
        key: metanorma-fontist
        restore-keys: metanorma-fontist

    - uses: actions/cache@v4
      with:
        path: |
          ~/.metanorma-ietf-workgroup-cache.json
          /root/.metanorma-ietf-workgroup-cache.json
        key: metanorma-ietf-workgroup-cache
        restore-keys: metanorma-ietf-workgroup-cache

    - if: ${{ inputs.cache-site-for-manifest != '' }}
      shell: bash
      run: npm install yaml

    - if: ${{ inputs.cache-site-for-manifest != '' }}
      id: input-hash
      uses: actions/github-script@v7
      env:
        METANORMA_MANIFEST: ${{ inputs.cache-site-for-manifest }}
        METANORMA_EXTRA_INPUT: ${{ inputs.extra-input }}
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          const yaml = require('yaml');

          const manifestPath = process.env.METANORMA_MANIFEST;
          const manifestContent = fs.readFileSync(manifestPath, 'utf8');
          const manifest = yaml.parse(manifestContent);
          const documentPaths = manifest.metanorma.source.files || [];
          const globDirs = new Set(documentPaths
            .map(documentPath => path.dirname(documentPath))
            .map(documentPath => path.join(documentPath, '**'))
          );

          process.env.METANORMA_EXTRA_INPUT
            .split(/[\n,]/)
            .map(input => path.join(input, '**'))
            .forEach(input => globDirs.add(input));

          console.log('Base directories:', globDirs);
          console.log('Input hash:', hashFiles(...globDirs));

          core.setOutput('input-dirs', globDirs);
          core.setOutput('input-hash', hashFiles(...globDirs));

    - if: ${{ inputs.cache-site-for-manifest != '' }}
      id: site-cache
      uses: actions/cache@v4
      with:
        path: ${{ inputs.cache-site-path }}
        key: metanorma-site-cache-${{ steps.input-hash.outputs.cache-hit }}
