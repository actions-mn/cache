[![GitHub tag (latest by date)](https://img.shields.io/github/v/tag/actions-mn/cache)](https://github.com/actions-mn/cache/releases)
[![test](https://github.com/actions-mn/cache/actions/workflows/test.yml/badge.svg)](https://github.com/actions-mn/cache/actions/workflows/test.yml)

# metanorma-cache

Cache metanorma-related assets to speed up CI builds.

## Features

- **System Asset Caching** - Always caches metanorma system directories
- **Site Output Caching** - Conditionally caches generated site output based on source files
- **Cross-Platform** - Works on Linux, macOS, and Windows runners
- **Type-Safe** - Written in TypeScript with full type definitions

## Usage

### Basic Usage (System Assets Only)

By default, this action caches metanorma system assets:

```yaml
- uses: actions-mn/cache@v2
```

This caches the following directories:
- `~/.metanorma` and `/root/.metanorma`
- `~/.fontist` and `/root/.fontist`
- `~/.relaton` and `/root/.relaton`
- `~/.metanorma-ietf-workgroup-cache.json` and `/root/.metanorma-ietf-workgroup-cache.json`

### Site Output Caching

To cache the generated site output based on your metanorma.yml manifest:

```yaml
- uses: actions-mn/cache@v2
  with:
    cache-site-for-manifest: metanorma.yml
```

This will:
1. Parse your `metanorma.yml` manifest file
2. Hash all source files listed in `metanorma.source.files`
3. Generate a cache key based on the file hashes
4. Cache the site output directory (default: `_site`)

### Advanced Configuration

```yaml
- uses: actions-mn/cache@v2
  with:
    cache-site-for-manifest: path/to/metanorma.yml
    extra-input: |
      assets
      templates
      config
    cache-site-path: site
```

## Inputs

| Input | Description | Default | Required |
|-------|-------------|---------|----------|
| `cache-site-for-manifest` | Path to metanorma.yml manifest file | `''` | No |
| `extra-input` | Comma/line separated directories affecting build (relative to manifest) | `''` | No |
| `cache-site-path` | Path to output site directory | `_site` | No |

## Outputs

| Output | Description |
|--------|-------------|
| `cache-site-cache-hit` | `"true"` if site cache was hit, `"false"` otherwise |

## How It Works

### Two-Tier Caching

This action implements a two-tier caching strategy:

1. **System Cache (Always)** - Caches metanorma installation assets
   - Key: `metanorma-cache`
   - Includes fonts, relaton data, and workgroup cache

2. **Site Cache (Conditional)** - Caches generated site output
   - Key: `metanorma-site-cache-{hash}`
   - Hash computed from source files in manifest
   - Only enabled when `cache-site-for-manifest` is provided

### Cache Key Generation

The site cache key is generated by:
1. Reading `metanorma.source.files` from the manifest
2. Extracting parent directories of each source file
3. Adding any `extra-input` directories
4. Computing SHA256 hash of all matched files

This ensures the cache is invalidated when any source file changes.

### Shared System Cache

The system cache (`metanorma-cache`) is **shared across all repositories** that use this action. This is intentional because:

- Metanorma fonts are universal and reusable across projects
- Fontist and Relaton caches contain generic data
- Sharing reduces overall cache storage and improves hit rates

**Note**: Your repository's site cache is **unique** to your project (based on your source file hashes).

## Example Workflow

```yaml
name: Build Metanorma Site

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions-mn/setup@main

      - uses: actions-mn/cache@v2
        with:
          cache-site-for-manifest: metanorma.yml

      - uses: actions-mn/site-gen@main
        with:
          source-path: .
          config-file: metanorma.yml
          agree-to-terms: true
          output-dir: site
```

## Troubleshooting

### Cache Not Working

If caching doesn't seem to be working:

1. **Check the cache key**: Ensure your `metanorma.yml` file exists and has valid `source.files` entries
2. **Verify file paths**: All source files must exist relative to the manifest file location
3. **Check cache size**: GitHub Actions cache has a 10GB per repository limit

### Manifest Validation Errors

The action validates manifest files and will fail with clear error messages for:

- **Non-existent files**: `Manifest file "path/to/metanorma.yml" does not exist`
- **Wrong extension**: `Manifest file must have .yml or .yaml extension`
- **Path is directory**: `Path is a directory, not a file`
- **Home directory paths**: `Path starts with ~. Use "$HOME" instead`
- **Path traversal**: Paths containing `..` are rejected for security reasons

### Cache Miss After Source Changes

This is expected behavior. The cache key is computed from the hash of all source files. When any source file changes:

1. The hash changes
2. A new cache key is generated
3. Cache miss occurs and new output is built
4. New output is cached for future runs

### System Cache vs Site Cache

- **System Cache** (`~/.metanorma`, `~/.fontist`, `~/.relaton`) is always cached regardless of inputs
- **Site Cache** only runs when `cache-site-for-manifest` is provided
- If you only need system caching, use the action without any inputs

### Permissions Errors

The action requires no special permissions for basic caching. If you see permission errors:

- Ensure the workflow has `contents: read` permission (default on public repos)
- For private repos, you may need to explicitly set `permissions: contents: read`

## License

MIT
